const login=document.querySelector(".login"),loginForm=document.querySelector(".login-form"),getEmail=document.querySelector(".login-email"),getPass=document.querySelector(".login-password"),signUp=document.querySelector(".login-signUp"),userElem=document.querySelector(".user"),userName=document.querySelector(".user-name"),exit=document.querySelector(".exit"),edit=document.querySelector(".edit"),editContainer=document.querySelector(".edit-container"),editUserNameField=document.querySelector(".edit-username"),editShowedPostsOnPageField=document.querySelector(".edit-postsCount"),userPhoto=document.querySelector(".user-photo"),postHolder=document.querySelector(".posts"),newPost=document.querySelector(".button-new-post"),addPostForm=document.querySelector(".add-post"),editPostForm=document.querySelector(".edit-post"),nextPage=document.querySelector(".next-page-button"),prevPage=document.querySelector(".prev-page-button"),adminEmail="nikita_rogulin@list.ru";let editablePostID,postsOnPage=0,allPostsCount=1e3;var firebaseConfig={apiKey:"AIzaSyAeCtzJKQ3wcfdJo2H08llymLSJmvHSxfU",authDomain:"vvsu-918d2.firebaseapp.com",databaseURL:"https://vvsu-918d2-default-rtdb.firebaseio.com",projectId:"vvsu-918d2",storageBucket:"vvsu-918d2.appspot.com",messagingSenderId:"1008028758662",appId:"1:1008028758662:web:603def98768b9e610c1707"};firebase.initializeApp(firebaseConfig);const database=firebase.database(),auth=firebase.auth(),defPhoto=userPhoto.src,updatePage=()=>{const e=setUsers.user;console.log(e),e?(login.style.display="none",userElem.style.display="",userName.textContent=e.displayName,userPhoto.src=e.photoURL||defPhoto,database.ref("users/"+e.uid).once("value",e=>{editShowedPostsOnPageField.value=e.val().postsOnPage}),newPost.classList.add("visible"),nextPage.classList.add("visible"),prevPage.classList.add("visible"),printPosts(e.uid),console.log("if")):(login.style.display="",userElem.style.display="none",newPost.classList.remove("visible"),addPostForm.classList.remove("visible"),postHolder.classList.add("visible"),nextPage.classList.remove("visible"),prevPage.classList.remove("visible"),printPosts(),console.log("e;se"))},setUsers={user:null,initUser(){auth.onAuthStateChanged(e=>{this.user=e||null,updatePage()})},logIn(e,t){auth.signInWithEmailAndPassword(e,t).catch(e=>{alert(e.message)})},logOut(){auth.signOut().then(()=>{clear()})},signUp(e,t){auth.createUserWithEmailAndPassword(e,t).then(t=>{this.editUser(e.substring(0,e.indexOf("@")),5),database.ref("users/"+auth.currentUser.uid).update({postsOnPage:5})}).catch(e=>{alert(e.message)})},editUser(e,t){const s=auth.currentUser;e&&s.updateProfile({displayName:e}).then(()=>{t&&database.ref("users/"+s.uid).update({postsOnPage:t}).then(()=>updatePage())})}},emailRegex=e=>{return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(e).toLowerCase())},clear=()=>{loginForm.reset()},loginInitialize=()=>{loginForm.addEventListener("submit",e=>{e.preventDefault(),setUsers.logIn(getEmail.value,getPass.value)}),signUp.addEventListener("click",e=>{e.preventDefault();const t=getEmail.value;emailRegex(t)?setUsers.signUp(t,getPass.value):(alert("Email wrong format"),clear())}),exit.addEventListener("click",e=>{e.preventDefault(),setUsers.logOut()}),edit.addEventListener("click",e=>{e.preventDefault(),editContainer.classList.toggle("visible"),editUserNameField.value=setUsers.user.displayName}),editContainer.addEventListener("submit",e=>{e.preventDefault(),setUsers.editUser(editUserNameField.value,editShowedPostsOnPageField.value>0?editShowedPostsOnPageField.value:5),editContainer.classList.remove("visible")}),setUsers.initUser()},printPosts=(e,t)=>{let s="",a=[],i=0;database.ref("post").orderByChild("id").once("value",e=>{(e||[]).forEach(e=>{a.push(`\n              <section class="post">\n                <div class="post-body">\n                  <h2 class="post-title">${e.val().title}</h2>\n                  <p class="post-text" >${e.val().text}</p>\n                </div>\n                <div class="post-footer">\n                  <div class="post-buttons">\n                  \n                  </div>\n                  <div class="post-author">\n                  ${setUsers.user&&(e.val().author.email===(setUsers.user.email||null)||setUsers.user.email===adminEmail)?`<button class="post-button post-button-delete" value="${e.val().id}" onclick="deletePost(value)">\n                  <svg class="icon icon-exit">\n                    <use xlink:href="img/icons.svg#exit"></use>\n                  </svg>\n                </button>`:""}\n                    ${setUsers.user&&(e.val().author.email===(setUsers.user.email||null)||setUsers.user.email===adminEmail)?`<button class="post-button post-button-edit" value="${e.val().id}" onclick="editPost(value)">\n                  <svg width="17" height="19" class="icon icon-edit">\n                    <use xlink:href="img/icons.svg#edit"></use>\n                  </svg>\n                </button>`:""}\n                    <div class="author-about">\n                      <a href="#" class="author-username">${e.val().author.displayName}</a>\n                      <span class="post-time">${e.val().date}</span>\n                    </div>\n                  <a href="#" class="author-link"><img src=${e.val().author.photo||"avatar.jpg"} alt="avatar" class="author-avatar"></a>\n                </div>\n                </div>\n              </section>`)})}).then(()=>{e?database.ref("users/"+e).once("value",e=>{if(allPostsCount=e.val().postsOnPage,0===parseInt(t)||1===parseInt(t))if(0===parseInt(t)&&postsOnPage<a.length-parseInt(allPostsCount))postsOnPage=parseInt(postsOnPage)+parseInt(allPostsCount);else{if(1!==parseInt(t)||0===postsOnPage)return;postsOnPage=parseInt(postsOnPage)-parseInt(allPostsCount)}i=0,a.reverse().forEach(e=>{i>=postsOnPage&&i<parseInt(postsOnPage)+parseInt(allPostsCount)&&(s+=e),i++}),postHolder.innerHTML=s,s="",addPostForm.classList.remove("visible"),editPostForm.classList.remove("visible"),postHolder.classList.add("visible")}):(postHolder.innerHTML='`<div class="button"> ВОЙДИТЕ В АККАУНТ ДЛЯ ПРОСМОТРА ПОСТОВ </div>`',s="",addPostForm.classList.remove("visible"),editPostForm.classList.remove("visible"),postHolder.classList.add("visible"))})},setAddPostForm=()=>{addPostForm.classList.add("visible"),postHolder.classList.remove("visible"),editPostForm.classList.remove("visible"),editPostForm.reset()},setEditPostForm=(e,t,s,a)=>{editPostForm.classList.add("visible"),editPostForm.elements.namedItem("edit-post-title").value=e,editPostForm.elements.namedItem("edit-post-text").value=t,editPostForm.elements.namedItem("edit-post-tags").value=s,editablePostID=a,postHolder.classList.remove("visible")},postHandlerInit=()=>{printPosts(),nextPage.addEventListener("click",e=>{e.preventDefault(),printPosts(auth.currentUser.uid,0)}),prevPage.addEventListener("click",e=>{e.preventDefault(),printPosts(auth.currentUser.uid,1)}),newPost.addEventListener("click",e=>{e.preventDefault(),addPostForm.classList.add("visible"),postHolder.classList.remove("visible"),editPostForm.classList.remove("visible"),editPostForm.reset()}),addPostForm.addEventListener("submit",e=>{e.preventDefault();const t=addPostForm.elements;if(t.namedItem("post-title").value.length<0)return void alert("Слишком короткий заголовок");if(t.namedItem("post-text").value.length<0)return void alert("Слишком короткий пост");const s="postID"+(+new Date).toString(16);database.ref("post/"+s).set({id:s,title:t.namedItem("post-title").value,text:t.namedItem("post-text").value,author:{displayName:setUsers.user.displayName,photo:setUsers.user.photoURL,email:setUsers.user.email},date:(new Date).toLocaleString()}),printPosts(auth.currentUser.uid),addPostForm.reset()}),editPostForm.addEventListener("submit",e=>{e.preventDefault();const t=editPostForm.elements;t.namedItem("edit-post-title").value.length<0?alert("Слишком короткий заголовок"):t.namedItem("edit-post-text").value.length<0?alert("Слишком короткий пост"):(database.ref("post/"+editablePostID).update({id:editablePostID,title:t.namedItem("edit-post-title").value,text:t.namedItem("edit-post-text").value,author:{displayName:setUsers.user.displayName,photo:setUsers.user.photoURL,email:setUsers.user.email},date:(new Date).toLocaleString()}),printPosts(auth.currentUser.uid),editPostForm.reset())})},deletePost=e=>{database.ref("post").once("value",t=>{t.forEach(t=>{t.val().id===e&&database.ref("post").child(t.key).remove().then(()=>(printPosts(auth.currentUser.uid),!0))})})},editPost=e=>{database.ref("post").once("value",t=>{t.forEach(t=>{t.val().id===e&&setEditPostForm(t.val().title,t.val().text,t.val().tags,e)})})};document.addEventListener("DOMContentLoaded",()=>{loginForm.addEventListener("submit",e=>{e.preventDefault(),setUsers.logIn(getEmail.value,getPass.value)}),signUp.addEventListener("click",e=>{e.preventDefault();const t=getEmail.value;emailRegex(t)?setUsers.signUp(t,getPass.value):(alert("Email wrong format"),clear())}),exit.addEventListener("click",e=>{e.preventDefault(),setUsers.logOut()}),edit.addEventListener("click",e=>{e.preventDefault(),editContainer.classList.toggle("visible"),editUserNameField.value=setUsers.user.displayName}),editContainer.addEventListener("submit",e=>{e.preventDefault(),setUsers.editUser(editUserNameField.value,editShowedPostsOnPageField.value>0?editShowedPostsOnPageField.value:5),editContainer.classList.remove("visible")}),setUsers.initUser(),printPosts(),nextPage.addEventListener("click",e=>{e.preventDefault(),printPosts(auth.currentUser.uid,0)}),prevPage.addEventListener("click",e=>{e.preventDefault(),printPosts(auth.currentUser.uid,1)}),newPost.addEventListener("click",e=>{e.preventDefault(),addPostForm.classList.add("visible"),postHolder.classList.remove("visible"),editPostForm.classList.remove("visible"),editPostForm.reset()}),addPostForm.addEventListener("submit",e=>{e.preventDefault();const t=addPostForm.elements;if(t.namedItem("post-title").value.length<0)return void alert("Слишком короткий заголовок");if(t.namedItem("post-text").value.length<0)return void alert("Слишком короткий пост");const s="postID"+(+new Date).toString(16);database.ref("post/"+s).set({id:s,title:t.namedItem("post-title").value,text:t.namedItem("post-text").value,author:{displayName:setUsers.user.displayName,photo:setUsers.user.photoURL,email:setUsers.user.email},date:(new Date).toLocaleString()}),printPosts(auth.currentUser.uid),addPostForm.reset()}),editPostForm.addEventListener("submit",e=>{e.preventDefault();const t=editPostForm.elements;t.namedItem("edit-post-title").value.length<0?alert("Слишком короткий заголовок"):t.namedItem("edit-post-text").value.length<0?alert("Слишком короткий пост"):(database.ref("post/"+editablePostID).update({id:editablePostID,title:t.namedItem("edit-post-title").value,text:t.namedItem("edit-post-text").value,author:{displayName:setUsers.user.displayName,photo:setUsers.user.photoURL,email:setUsers.user.email},date:(new Date).toLocaleString()}),printPosts(auth.currentUser.uid),editPostForm.reset())})});